name: Build and Test on PR

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  IOS_BUNDLE_ID: "io.novafoundation.novawallet.dev"
  IOS_EXTENSION_BUNDLE_ID: "io.novafoundation.novawallet.dev.NovaPushNotificationServiceExtension"
  PROVISIONING_PROFILE_SPECIFIER: "match Development io.novafoundation.novawallet.dev"
  EXTENSION_PROVISIONING_PROFILE_SPECIFIER: "match Development io.novafoundation.novawallet.dev.NovaPushNotificationServiceExtension"
  CODE_SIGN_IDENTITY: "Apple Development"
  EXPORT_METHOD: "development"
  BUILD_NUMBER: ${{ github.run_number }}
  RUN_IN_CI: true
  # DEBUG MODE: Set to 'true' to enable enhanced debugging for build failures
  # What it does:
  #   - Enables verbose xcodebuild logging
  #   - Collects and uploads build artifacts (logs, test results)
  #   - Continues build even on failures to gather maximum information
  DEBUG_CI: false

jobs:
  build:
    name: Build app
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup iOS Environment
        uses: ./.github/actions/install
        with:
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_default_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          scw_default_organization_id: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}

      - name: Build app
        run: |
          # Pass debug flag to fastlane if DEBUG_CI is enabled
          if [ "${{ env.DEBUG_CI }}" = "true" ]; then
            echo "üîç Building app in debug mode..."
            bundle exec fastlane build_app_ci debug:true
          else
            bundle exec fastlane build_app_ci
          fi

      # Upload build artifacts for debugging - only when DEBUG_CI is enabled
      - name: Upload build artifacts
        if: env.DEBUG_CI == 'true' && (failure() || success())
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            ./fastlane/build_logs/
          retention-days: 3

  test:
    name: Run tests
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Setup iOS Environment
        uses: ./.github/actions/install
        with:
          scw_access_key: ${{ secrets.SCW_ACCESS_KEY }}
          scw_secret_key: ${{ secrets.SCW_SECRET_KEY }}
          scw_default_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          scw_default_organization_id: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}

      - name: Run tests
        run: bundle exec fastlane run_unit_tests
